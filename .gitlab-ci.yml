# Configuration for Gitlab-CI.
# Builds appear on https://gitlab.com/buildroot.org/buildroot/pipelines
# The .gitlab-ci.yml file is generated from .gitlab-ci.yml.in.
# It needs to be regenerated every time a defconfig is added, using
# "make .gitlab-ci.yml".

image: maohan001/ubuntu-buildroot

stages:
  - build
  - test
  - deploy

.build_buildroot: &build_buildroot
    - echo 'Configure Buildroot'
    - make ${CI_BUILD_NAME}
    - echo 'Build buildroot'
    - |
        make > >(tee build.log |grep '>>>') 2>&1 || {
            echo 'Failed build last output'
            tail -200 build.log
            exit 1
        }

.run_test: &run_test
    - echo 'Run test'
    - tar -xf output/images/csky_toolchain_*.tar.gz -C output/host
    - |
        ./output/host/csky-ci/run_test.sh || {
            exit 1
        }

.defconfig: &defconfig
    stage: build
    script: *build_buildroot
    cache:
      paths:
        - dl/
    artifacts:
        when: always
        expire_in: 7 day
        paths:
            - output/host/csky-ci
            - output/host/csky-qemu
            - output/images/
            
.localbuild_defconfig: &localbuild_defconfig
    stage: build
    tags:
      - vmh
    script:
    - echo 'Configure Buildroot'
    - make ${CI_BUILD_NAME}
    - echo 'Build buildroot'
    - |
        make > >(tee build.log |grep '>>>') 2>&1 || {
            echo 'Failed build last output'
            tail -200 build.log
            exit 1
        }
    - BUILDROOT_VERSION=$(git log --pretty=oneline|awk 'NR==1'|awk '{print $1}')
    - if [ -f /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}_test ]; then
          rm /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}_test; 
      fi
    - mkdir -p /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}_test
    - mv output/host/csky-ci /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}_test
    - mv output/images /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}_test

csky_gx6605s_defconfig: *defconfig
csky_gx6605s_fbcon_defconfig: *defconfig
qemu_csky_ck810f_4.16_uclibc_defconfig: *defconfig
qemu_csky_ck807_4.9_glibc_defconfig: *defconfig
qemu_csky_ck807f_4.16_glibc_defconfig: *defconfig
qemu_csky_ck810f_4.16_glibc_defconfig: *defconfig
qemu_csky_ck807_4.16_uclibc_defconfig: *defconfig
qemu_csky_ck610_4.16_uclibc_defconfig: *defconfig
qemu_csky_ck610_4.9_glibc_defconfig: *defconfig
csky_ck810_sc8925_4.9_glibc_bt_defconfig: *defconfig
csky_eragon3_defconfig: *defconfig

csky_ck610_gx6622_4.16_glibc_bt_defconfig: *localbuild_defconfig
csky_ck610_gx6622_4.9_uclibc_bt_defconfig: *localbuild_defconfig
csky_ck807_eragon_4.9_glibc_bt_defconfig: *localbuild_defconfig

qemu_csky_ck810f_4.16_uclibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck810f_4.16_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807_4.9_glibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck807_4.9_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck810f_4.16_glibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck810f_4.16_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807f_4.16_glibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck807f_4.16_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck807_4.16_uclibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck807_4.16_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck610_4.9_glibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck610_4.9_glibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

qemu_csky_ck610_4.16_uclibc_defconfig_test:
    stage: test
    script: *run_test
    dependencies:
      - qemu_csky_ck610_4.16_uclibc_defconfig
    artifacts:
        when: always
        expire_in: 2 weeks
        paths:
            - test.log
            - test_sum.log

#csky_ck810_sc8925_bt_defconfig_test:
#    stage: test
#    tags:
#      - vmh-sc8925
#    script:
#      - echo 'Run test'
#      - ./output/host/csky-ci/gen_rtb.sh
#      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_sc8925
#      - sleep 30
#      - |
#          ./output/host/csky-ci/run_test.sh _sc8925 || {
#              exit 1
#          }
#      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_exit_sc8925
#    dependencies:
#      - csky_ck810_sc8925_4.9_glibc_bt_defconfig
#    artifacts:
#        when: always
#        expire_in: 2 weeks
#        paths:
#            - test.log
#            - test_sum.log

csky_ck610_gx6622_4.9_uclibc_bt_defconfig_test:
    stage: test
    tags:
      - vmh-gx6622
    script:
      - echo 'Run test'
      - /home/vmh/workspace/switch/switch /dev/ttyUSB2 on
      - BUILDROOT_VERSION=$(git log --pretty=oneline|awk 'NR==1'|awk '{print $1}')
      - if [ ! -d /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME} ]; then
           exit 1;
        fi
      - mkdir -p output/host/
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/csky-ci output/host/csky-ci -r
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/images output/images -r
      - tar -xf output/images/csky_toolchain_*.tar.gz -C output/host
      - ./output/host/csky-ci/gen_rtb.sh
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_gx6622
      - sleep 30
      - |
          ./output/host/csky-ci/run_test.sh _gx6622 || {
              exit 1
          }
      - rm output/images/rootfs output/images/vmlinux output/images/rootfs.tar output/images/.gdbinit output/images/*.dtb -rf
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_exit_gx6622
      - /home/vmh/workspace/switch/switch /dev/ttyUSB2 off
    dependencies:
      - csky_ck610_gx6622_4.9_uclibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - output/images/
            - test.log
            - test_sum.log

csky_ck610_gx6622_4.16_glibc_bt_defconfig_test:
    stage: test
    tags:
      - vmh-gx6622
    script:
      - echo 'Run test'
      - /home/vmh/workspace/switch/switch /dev/ttyUSB2 on
      - BUILDROOT_VERSION=$(git log --pretty=oneline|awk 'NR==1'|awk '{print $1}')
      - if [ ! -d /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME} ]; then
           exit 1;
        fi
      - mkdir -p output/host/
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/csky-ci output/host/csky-ci -r
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/images output/images -r
      - tar -xf output/images/csky_toolchain_*.tar.gz -C output/host
      - ./output/host/csky-ci/gen_rtb.sh
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_gx6622
      - sleep 30
      - |
          ./output/host/csky-ci/run_test.sh _gx6622 || {
              exit 1
          }
      - rm output/images/rootfs output/images/vmlinux output/images/rootfs.tar output/images/.gdbinit output/images/*.dtb -rf
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_exit_gx6622
      - /home/vmh/workspace/switch/switch /dev/ttyUSB2 off
    dependencies:
      - csky_ck610_gx6622_4.16_glibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - output/images/
            - test.log
            - test_sum.log

csky_ck807_eragon_4.9_glibc_bt_defconfig_test:
    stage: test
    tags:
      - vmh-eragon
    script:
      - echo 'Run test'
      - BUILDROOT_VERSION=$(git log --pretty=oneline|awk 'NR==1'|awk '{print $1}')
      - if [ ! -d /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME} ]; then
           exit 1;
        fi
      - mkdir -p output/host/
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/csky-ci output/host/csky-ci -r
      - cp /root/builds/build_tmp/$BUILDROOT_VERSION/${CI_BUILD_NAME}/images output/images -r
      - tar -xf output/images/csky_toolchain_*.tar.gz -C output/host
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_eragon
      - sleep 30
      - |
          ./output/host/csky-ci/run_test.sh _eragon || {
              exit 1
          }
      - rm output/images/rootfs output/images/vmlinux output/images/rootfs.tar output/images/.gdbinit output/images/*.dtb -rf
      - touch /home/vmh/workspace/DebugServerConsole/.stamp_gdb_exit_eragon
    dependencies:
      - csky_ck807_eragon_4.9_glibc_bt_defconfig
    artifacts:
        when: on_success
        paths:
            - test.log
            - test_sum.log

deploy_github:
    stage: deploy
    script:
      - echo deploy
